<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="/pages/checkout-catering.css">
</head>
<body>
<div class="container">
    <h2>Checkout</h2>
    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'cart')">Cart</button>
        <button class="tablinks" onclick="openTab(event, 'delivery')">Delivery</button>
        <button class="tablinks" onclick="openTab(event, 'payment')">Payment</button>
    </div>
    <div id="cart" class="tabcontent" style="display: block;">
        <div class="card">
            <h3>Items</h3>
            <div id="cartList"></div>
        </div>
        <div class="card">
            <h3>Tip</h3>
            <input type="number" id="tipAmount" min="0">
        </div>
        <div class="card">
            <h3>Delivery Address</h3>
            <select id="addressID">
                <option value="">Select an address</option>
            </select>
            <button id="addAddressBtn" onclick="document.getElementById('deliveryAddressPopup').style.display='block'">Add New Address</button>
            <div id="deliveryAddressPopup" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="document.getElementById('deliveryAddressPopup').style.display='none'">&times;</span>
                    <input type="text" id="newAddressInput" placeholder="Enter new address">
                    <button id="saveAddressBtn">Save Address</button>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Delivery Date & Time</h3>
            <div class="delivery-date">
                <label for="datePicker">Select Date and Time Range:</label>
                <input type="text" id="datePicker" placeholder="Select Date and Time">
            </div>
            <div class="delivery-date">
                <label for="timeslot">Select Delivery Time Slot:</label>
                <select id="timeslot"></select>
            </div>
        </div>
        <div class="card">
            <h3>Comments</h3>
            <textarea id="comment" placeholder="Add any special instructions here..."></textarea>
        </div>
    </div>
    <div id="delivery" class="tabcontent">
        <div class="card">
            <h3>Delivery Method</h3>
            <div class="delivery-method">
                <input type="radio" id="deliveryMethod1" name="deliveryMethod" value="standard" checked>
                <label for="deliveryMethod1">Standard Delivery ($5.29)</label>
            </div>
            <div class="delivery-method">
                <input type="radio" id="deliveryMethod2" name="deliveryMethod" value="express">
                <label for="deliveryMethod2">Express Delivery ($9.99)</label>
            </div>
        </div>
    </div>
    <div id="payment" class="tabcontent">
        <div class="card" id="stripePayment">
            <h3>Pay with Stripe</h3>
            <button id="stripePayButton">Pay with Stripe</button>
        </div>
        <div class="card" id="paypalPayment">
            <h3>Pay with PayPal</h3>
            <button id="paypalPayButton">Pay with PayPal</button>
        </div>
    </div>
    <div id="checkoutSummary" class="card summary-details"></div>
    <div class="text-center">
        <button onclick="submitOrder()">Submit Order</button>
    </div>
</div>







<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>

document.addEventListener('DOMContentLoaded', function() {
    // Parse the cart data from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const cartData = urlParams.get('cart');
    const cartItems = JSON.parse(decodeURIComponent(cartData));

    // Add event listener to tip input
    const tipInput = document.getElementById('tipAmount');
    tipInput.addEventListener('change', function() {
        updateTotalPrice();
    });

    // Initialize tip input with default value
    tipInput.value = 0; // Default tip amount is $0

    // Render cart items
    const cartItemsContainer = document.getElementById('cartList');
    const deliveryAddress = document.getElementById('addressID');
    const checkoutSummary = document.getElementById('checkoutSummary');
    const deliveryAddressPopup = document.getElementById('deliveryAddressPopup');

    let totalPrice = 0;
    let itemsMap = new Map(); // To store items with their quantities

    cartItems.forEach(item => {
        const itemTotal = item.price * item.quantity;
        totalPrice += itemTotal;

        if (itemsMap.has(item.name)) {
            // If item already exists in the map, update its quantity
            itemsMap.set(item.name, itemsMap.get(item.name) + item.quantity);
        } else {
            // If item is not in the map, add it with its quantity
            itemsMap.set(item.name, item.quantity);
        }
    });

    // Render items from itemsMap
    itemsMap.forEach((quantity, name) => {
        const itemElement = document.createElement('div');
        itemElement.classList.add('item-container');

        const itemTotal = cartItems.find(item => item.name === name).price * quantity;

        // Construct the image URL using the item name directly
        const imagePath = `/menu/uplifted-bistro-order-page/box-lunch.jpg`;

        itemElement.innerHTML = `
            <div class="item-details">
                <div>${name}</div>
                <div class="item-image">
                    <img src="${imagePath}" alt="${name}" style="width: 50px; height: 50px;">
                </div>
                <div class="quantity-actions">
                    <button class="btn-action" onclick="decreaseQuantity(this, '${name}')">-</button>
                    <span>${quantity}</span>
                    <button class="btn-action" onclick="increaseQuantity(this, '${name}')">+</button>
                    <button class="btn-action" onclick="deleteItem(this, '${name}')">Delete</button>
                </div>
                <div class="quantity-price">${quantity} x $${(itemTotal / quantity).toFixed(2)}</div>
            </div>
        `;
        cartItemsContainer.appendChild(itemElement);
    });

    // Set delivery time based on current time and restaurant working hours
    const currentTime = new Date();
    const currentHour = currentTime.getHours();
    const workingHours = { start: 8, end: 20 }; // Assuming working hours are from 8 AM to 8 PM

    // Calculate delivery time slots
    const deliveryTimeSlots = [];
    for (let hour = currentHour + 1; hour <= workingHours.end; hour++) {
        deliveryTimeSlots.push(hour);
    }

    // Populate delivery time slots dropdown
    const deliveryTimeSlot = document.getElementById('timeslot');
    deliveryTimeSlots.forEach(hour => {
        const option = document.createElement('option');
        option.text = `${hour}:00 - ${hour + 1}:00`;
        option.value = `${hour}`;
        deliveryTimeSlot.appendChild(option);
    });

    // Initialize Flatpickr for date selection
    const datePicker = flatpickr("#datePicker", {
        mode: "range",
        dateFormat: "Y-m-d",
        minDate: "today",
        maxDate: new Date().fp_incr(30),
        disable: [
            function(date) {
                // Disable Sundays
                return date.getDay() === 0;
            }
        ],
        // Default date to the next day
        defaultDate: [new Date().fp_incr(1), new Date().fp_incr(1)]
    });

    // Display total price and update checkout summary
    updateTotalPrice();

    // Add event listener to Apply button
    const applyButton = document.getElementById('applyButton');
    applyButton.addEventListener('click', function() {
        updateTotalPrice(); // Update total price after applying the selection
    });

    // Add event listener to Save Address button in popup
    document.getElementById('saveAddressBtn').addEventListener('click', function() {
        const newAddress = document.getElementById('newAddressInput').value;
        if (newAddress.trim() !== '') {
            // Add new address to dropdown
            const option = document.createElement('option');
            option.text = newAddress;
            option.value = newAddress;
            document.getElementById('addressID').appendChild(option);
            addresses.push(newAddress);
        }
        document.getElementById('deliveryAddressPopup').style.display = 'none';
    });
});

// Function to increase quantity
function increaseQuantity(element, name) {
    const quantitySpan = element.parentElement.querySelector('span');
    let quantity = parseInt(quantitySpan.textContent);
    quantity++;
    quantitySpan.textContent = quantity;
    updateTotalPrice();
}

// Function to decrease quantity
function decreaseQuantity(element, name) {
    const quantitySpan = element.parentElement.querySelector('span');
    let quantity = parseInt(quantitySpan.textContent);
    if (quantity > 1) {
        quantity--;
        quantitySpan.textContent = quantity;
        updateTotalPrice();
    }
}

// Function to delete item
function deleteItem(element, name) {
    const itemContainer = element.closest('.item-container');
    itemContainer.remove();
    updateTotalPrice();
}

// Function to update total price and other summary details
function updateTotalPrice() {
    const itemContainers = document.querySelectorAll('.item-container');
    let subtotal = 0;

    // Get selected date range
    const selectedDates = document.getElementById('datePicker').value.split(" to ");
    const startDate = new Date(selectedDates[0]);
    const endDate = new Date(selectedDates[1] || selectedDates[0]); // Use startDate if endDate is not selected

    // Calculate number of days in the range, excluding Sundays
    let totalDays = 0;
    if (selectedDates.length === 2) {
        totalDays = calculateTotalDays(startDate, endDate);
    } else {
        // If only one day is selected, calculate totalDays accordingly
        totalDays = calculateTotalDays(startDate, startDate);
    }

    // Update itemsMap and recalculate subtotal
    itemContainers.forEach(itemContainer => {
        const quantityElement = itemContainer.querySelector('.quantity-actions span');
        const quantity = parseInt(quantityElement.textContent);
        const price = parseFloat(itemContainer.querySelector('.quantity-price').textContent.split('$')[1]);

        subtotal += quantity * price * totalDays;
    });

    // Calculate taxes and fees based on a tax rate (percentage)
    const taxRate = 0.20; // 20% tax rate
    const taxesAndFees = subtotal * taxRate;

    // Fixed delivery fee
    const deliveryFee = 5.29;

    // Tip amount
    const tipAmount = parseFloat(document.getElementById('tipAmount').value) || 0.00;

    // Discount amount
    const discountAmount = 0.00;

    // Calculate total price
    const total = subtotal + taxesAndFees + deliveryFee + tipAmount - discountAmount;

    // Update checkout summary
    const checkoutSummary = document.getElementById('checkoutSummary');
    checkoutSummary.innerHTML = `
        Sub Total:     $${subtotal.toFixed(2)}<br>
        Taxes and Fees: $${taxesAndFees.toFixed(2)}<br>
        Delivery:       $${deliveryFee.toFixed(2)}<br>
        Discount:       $${discountAmount.toFixed(2)}<br>
        Tip:            $${tipAmount.toFixed(2)}<br><br>
        <strong>Total Price: $${total.toFixed(2)}</strong>
    `;
}

// Function to calculate total days in the range, excluding Sundays
function calculateTotalDays(startDate, endDate) {
    let totalDays = 0;
    for (let day = new Date(startDate); day <= endDate; day.setDate(day.getDate() + 1)) {
        if (day.getDay() !== 0) totalDays++;
    }
    return totalDays;
}


</script>
</body>
</html>